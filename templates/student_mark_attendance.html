{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center g-4">
    <div class="col-lg-8">
        <div class="glass-card">
            <h2 class="mb-2">Student Session Attendance</h2>
            <p class="text-muted">Choose active class, then verify face + location to mark attendance.</p>

            <div class="row g-2 mb-3 text-start">
                <div class="col-md-4"><div class="mini-check">Live session required</div></div>
                <div class="col-md-4"><div class="mini-check">Single-face verification</div></div>
                <div class="col-md-4"><div class="mini-check">Campus geofence required</div></div>
            </div>

            <div class="mb-3">
                <label for="session-id" class="form-label">Active Session</label>
                <select id="session-id" class="form-select" {% if not active_sessions %}disabled{% endif %}>
                    {% if active_sessions %}
                    {% for session in active_sessions %}
                    <option value="{{ session.id }}">{{ session.course_code }} - {{ session.title }} ({{ session.room }}) ends {{ session.ends_at|localdtfmt('%I:%M %p') }}</option>
                    {% endfor %}
                    {% else %}
                    <option value="">No active sessions right now</option>
                    {% endif %}
                </select>
            </div>

            <div id="location-status" class="alert alert-info py-2 small mb-3">Getting geolocation...</div>
            <div id="challenge-box" class="challenge-box mb-3">Liveness prompt: hold your face in the center circle.</div>

            <div class="camera-container mb-4 text-center">
                <video id="video-preview" autoplay muted playsinline></video>
                <div class="scan-overlay"></div>
                <div id="status-text" class="mt-2 fw-bold text-primary pulse">Camera Ready</div>
            </div>

            <button id="mark-btn" class="btn btn-custom btn-lg w-100" disabled>Verify and Mark Session Attendance</button>
            <button id="refresh-btn" class="btn btn-outline-secondary btn-sm mt-2">Refresh Active Sessions</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
    const video = document.getElementById('video-preview');
    const markBtn = document.getElementById('mark-btn');
    const statusText = document.getElementById('status-text');
    const locStatus = document.getElementById('location-status');
    const sessionSelect = document.getElementById('session-id');
    const refreshBtn = document.getElementById('refresh-btn');
    const csrfToken = window.getCsrfToken();

    let userCoords = { lat: null, lng: null };
    let modelsLoaded = false;
    const deviceId = (() => {
        const key = 'attendance_device_id';
        let id = localStorage.getItem(key);
        if (!id) {
            id = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
            localStorage.setItem(key, id);
        }
        return id;
    })();

    async function loadModels() {
        statusText.innerText = 'Loading AI Models...';
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        modelsLoaded = true;
        statusText.innerText = 'Camera Ready';
        checkReady();
    }

    function checkReady() {
        const hasSession = !!sessionSelect.value;
        markBtn.disabled = !(modelsLoaded && userCoords.lat !== null && hasSession);
    }

    async function refreshSessions() {
        const res = await fetch('/api/active_sessions');
        const data = await res.json();
        sessionSelect.innerHTML = '';

        if (data.sessions && data.sessions.length) {
            data.sessions.forEach((s) => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.course_code} - ${s.title} (${s.room}) ends ${s.ends_at}`;
                sessionSelect.appendChild(opt);
            });
            sessionSelect.disabled = false;
        } else {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No active sessions right now';
            sessionSelect.appendChild(opt);
            sessionSelect.disabled = true;
        }
        checkReady();
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userCoords.lat = position.coords.latitude;
                userCoords.lng = position.coords.longitude;
                locStatus.className = 'alert alert-success py-2 small mb-3';
                locStatus.textContent = 'Location verified.';
                checkReady();
            },
            () => {
                locStatus.className = 'alert alert-danger py-2 small mb-3';
                locStatus.textContent = 'Location access required.';
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
            loadModels();
        })
        .catch(() => {
            statusText.innerText = 'Camera access denied.';
            statusText.className = 'mt-2 fw-bold text-danger';
        });

    sessionSelect.addEventListener('change', checkReady);
    refreshBtn.addEventListener('click', refreshSessions);

    markBtn.addEventListener('click', async () => {
        statusText.innerText = 'Running verification...';
        statusText.className = 'mt-2 fw-bold text-primary';
        markBtn.disabled = true;

        const allFaces = await faceapi.detectAllFaces(video)
            .withFaceLandmarks()
            .withFaceDescriptors();

        if (!allFaces || allFaces.length === 0) {
            statusText.innerText = 'No face detected. Look directly at camera.';
            statusText.className = 'mt-2 fw-bold text-danger';
            markBtn.disabled = false;
            return;
        }

        if (allFaces.length > 1) {
            statusText.innerText = 'Multiple faces detected. Only one person allowed.';
            statusText.className = 'mt-2 fw-bold text-danger';
            markBtn.disabled = false;
            return;
        }

        const descriptor = Array.from(allFaces[0].descriptor);

        try {
            const response = await fetch('/api/session_attendance/mark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({
                    session_id: Number(sessionSelect.value),
                    descriptor: descriptor,
                    lat: userCoords.lat,
                    lng: userCoords.lng,
                    device_id: deviceId
                })
            });

            const result = await response.json();
            if (result.success) {
                statusText.innerText = result.message;
                statusText.className = 'mt-2 fw-bold text-success';
                setTimeout(() => window.location.href = '/dashboard', 1500);
            } else {
                statusText.innerText = result.message || 'Verification failed.';
                statusText.className = 'mt-2 fw-bold text-danger';
                checkReady();
            }
        } catch (_) {
            statusText.innerText = 'Connection error. Try again.';
            statusText.className = 'mt-2 fw-bold text-danger';
            checkReady();
        }
    });
</script>
{% endblock %}

